# Typed Analyzer Setup

Perf Fiscal's cross-file insights rely on the TypeScript program that powers your project. This guide walks through the
prerequisites, `tsconfig` settings, and ESLint parser configuration required to unlock typed diagnostics.

## Prerequisites

- **Node.js 18 or newer** so ESLint, TypeScript, and the plugin run with full language support.
- **ESLint 8.57+ or 9.x** along with `@typescript-eslint/parser` 6.x/7.x — Perf Fiscal consumes parser services generated by
  that parser to reach the TypeScript type checker.
- **TypeScript 5.0 or newer** installed in your project. Older releases may omit syntax and compiler APIs used by the analyzer.
- A **project-aware `tsconfig` file** that includes every TypeScript/TSX file you want the analyzer to inspect. For monorepos or
  workspaces, add one config per package and reference the correct file from ESLint.

## Required `tsconfig` Options

The analyzer reads whichever `tsconfig` file you point ESLint to. Ensure it:

- Enables the TypeScript language service without producing output by setting `"noEmit": true` (or using a purely type-checking
  config such as `tsconfig.eslint.json`).
- Includes all source folders through the `include`/`exclude` patterns so the compiler can build a complete program graph.
- Matches your runtime module strategy, JSX transform, and libraries — the checker must successfully parse every file you lint.
- Provides React JSX settings when linting `.tsx` files.

A minimal baseline looks like this:

```jsonc
{
  "extends": "./tsconfig.json", // reuse your build settings if available
  "compilerOptions": {
    "noEmit": true,
    "lib": ["DOM", "DOM.Iterable", "ES2022"],
    "module": "ESNext",
    "moduleResolution": "NodeNext",
    "target": "ES2022",
    "jsx": "react-jsx",
    "allowJs": true, // only if you lint JS files that participate in the program
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "skipLibCheck": true,
    "strict": true
  },
  "include": ["src", "app", "tests", "*.ts", "*.tsx"],
  "exclude": ["dist", "build", "coverage"]
}
```

> **Tip:** In monorepos, point ESLint at package-relative configs and set `tsconfigRootDir` so the parser resolves the file
> from each package directory instead of the repository root.

## ESLint Parser Configuration

Perf Fiscal automatically enables typed rules when parser services are available. Configure ESLint to use
`@typescript-eslint/parser` with the project file above.

### Flat Config (`eslint.config.js` / `eslint.config.mjs`)

```js
import tsParser from '@typescript-eslint/parser';
import perfFiscal from 'eslint-plugin-perf-fiscal';

export default [
  {
    files: ['**/*.ts', '**/*.tsx'],
    languageOptions: {
      parser: tsParser,
      parserOptions: {
        project: ['./tsconfig.eslint.json'],
        tsconfigRootDir: import.meta.dirname
      }
    },
    plugins: {
      'perf-fiscal': perfFiscal
    },
    rules: {
      ...perfFiscal.configs.recommended.rules
    }
  }
];
```

- Use `import.meta.dirname` (or `new URL('.', import.meta.url)` in ESM) so monorepos resolve the `tsconfig` relative to each
  config file.
- If you share language options globally, add a project-specific override for test or tooling folders with different configs.

### Classic Config (`.eslintrc.js` / `.eslintrc.cjs` / JSON)

```js
module.exports = {
  parser: '@typescript-eslint/parser',
  parserOptions: {
    project: ['./tsconfig.eslint.json'],
    tsconfigRootDir: __dirname
  },
  plugins: ['perf-fiscal'],
  extends: ['plugin:perf-fiscal/recommended']
};
```

- `tsconfigRootDir` must point to the directory that contains the referenced `tsconfig` file.
- When multiple packages reuse the config, export a function that sets `tsconfigRootDir` dynamically or provide per-package
  config files.

## Troubleshooting

| Symptom | Likely Cause | Fix |
| --- | --- | --- |
| `Error: Parsing error: Cannot read file 'tsconfig.eslint.json'` | ESLint resolved the path from the wrong directory. | Set `tsconfigRootDir` to `__dirname` (classic) or `import.meta.dirname` (flat) so paths resolve relative to the config file. |
| `Error: You have used a rule which requires parserServices to be generated.` | The parser is not project-aware. | Ensure `parserOptions.project` points to a valid `tsconfig` that includes the file being linted. |
| Type errors from unrelated packages slow linting. | The shared config pulls in too many files. | Create a lint-specific `tsconfig` with targeted `include` patterns, or leverage [project references](https://www.typescriptlang.org/docs/handbook/project-references.html). |
| `Cannot find module` diagnostics for aliased paths. | `tsconfig` omits path mappings. | Mirror your build-time `paths` / `baseUrl` settings inside the lint `tsconfig` so the analyzer can resolve the same imports. |

With these settings in place, rules that depend on typed analysis — such as `no-unstable-inline-props` and `no-unhandled-promises` — automatically upgrade their diagnostics with cross-file context.
